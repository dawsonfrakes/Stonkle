<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stonkla</title>
  <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
  <link rel="shortcut icon" href="/favicon/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
  <link rel="manifest" href="/favicon/site.webmanifest" />
  <style>
    html, body {
      height: 100%;
      font-family: sans-serif;
      font-weight: 100;
    }
    body {
      color: #FFFFFF;
      background-color: #333333;
    }
    .centered {
      display: flex;
      justify-content: center;
    }
  </style>
</head>
<body>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel" data-type="module" data-presets="typescript,react,flow">
    import React from "https://esm.sh/react?dev";
    import ReactDOM from "https://esm.sh/react-dom/client?dev";
    const { useState, useRef, useEffect } = React;

    const TRANSLATIONS = {
      "en": {
        "title": "Stonkla",
        "connect": "Connect",
        "disconnect": "Disconnect",
        "api-key": "API Key",
        "api-secret": "API Secret",
        "locale": "Locale",
        "current-locale": flag => `Locale: ${flag}`,
        "flag": "ðŸ‡ºðŸ‡¸",
        "account-buying-power": amount => `Buying Power: ${amount}`,
        "currency": "USD",
      },
      "fr": {
        "title": "Stonkla",
        "connect": "Connecter",
        "disconnect": "DÃ©connecter",
        "api-key": "ClÃ© API",
        "api-secret": "API secrÃ¨te",
        "locale": "Lieu",
        "current-locale": flag => `Lieu: ${flag}`,
        "flag": "ðŸ‡«ðŸ‡·",
        "account-buying-power": amount => `Pouvoir d'achat: ${amount}`,
        "currency": "EUR",
      },
    };

    const ConnectionState = {
      DISCONNECTED: 0,
      FAILED: 1,
      CONNECTING: 2,
      CONNECTED: 3,
    };

    function Locale({ T, locale, setLocale }) {
      return (
        <div className="centered">
          <span onClick={e => setLocale("en")}>{TRANSLATIONS["en"]["flag"]}</span>
          <span onClick={e => setLocale("fr")}>{TRANSLATIONS["fr"]["flag"]}</span>
          {T("current-locale")(T("flag"))}
        </div>
      );
    }

    function AlpacaConnection({ T, locale, connection, setConnection }) {
      const [apiKey, setApiKey] = useState(localStorage.getItem("api-key") || "");
      const [apiSecret, setApiSecret] = useState("");

      useEffect(() => localStorage.setItem("api-key", apiKey), [apiKey]);

      function handleConnect(e) {
        e.preventDefault();
        if (e.target.parentNode.reportValidity()) {
          if (connection <= ConnectionState.FAILED) {
            setConnection(ConnectionState.CONNECTED);
          }
        }
      }

      function handleDisconnect() {
        console.assert(connection === ConnectionState.CONNECTED);
        setConnection(ConnectionState.DISCONNECTED);
      }

      return (
        <div className="centered">
          {connection !== ConnectionState.CONNECTED ?
            <form>
              <label>
                {T("api-key")}
                <input type="text" required placeholder={T("api-key")} value={apiKey} onChange={e => setApiKey(e.target.value)} />
              </label>
              <label>
                {T("api-secret")}
                <input type="password" required placeholder={T("api-secret")} value={apiSecret} onChange={e => setApiSecret(e.target.value)} />
              </label>
              <button onClick={handleConnect}>{T("connect")}</button>
            </form> :
            <button onClick={handleDisconnect}>{T("disconnect")}</button>
          }
        </div>
      );
    }

    function AlpacaAccount({ T, locale, connection }) {
      const C = amount => new Intl.NumberFormat(locale, { style: "currency", currency: T("currency") }).format(amount);
      return (
        <div className="centered">
          {T("account-buying-power")(C(100.28))}
        </div>
      );
    }

    function App() {
      const [locale, setLocale] = useState(localStorage.getItem("locale") || navigator.language.slice(0, 2));
      const [connection, setConnection] = useState(ConnectionState.DISCONNECTED);

      const T = key => TRANSLATIONS[locale][key];

      useEffect(() => localStorage.setItem("locale", locale), [locale]);

      return (
        <>
          <title>{T("title")}</title>
          <Locale T={T} locale={locale} setLocale={setLocale} />
          <AlpacaConnection T={T} locale={locale} connection={connection} setConnection={setConnection} />
          {connection === ConnectionState.CONNECTED && <AlpacaAccount T={T} locale={locale} connection={connection} />}
        </>
      );
    }

    ReactDOM.createRoot(document.body).render(<App />)
  </script>
</body>
</html>
